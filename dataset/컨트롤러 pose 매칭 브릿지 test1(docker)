#!/usr/bin/env python3
"""
ğŸ¯ ë°ì´í„° ìˆ˜ì§‘ìš© VR Bridge (ê°„ì†Œí™”)
- VR poseë§Œ ì „ì†¡ (ì œì–´ ì—†ìŒ)
- MuJoCo ìˆ˜ì§‘ê¸°ì™€ ì—°ë™
- ì‹¤ì‹œê°„ ìº˜ë¦¬ë¸Œë ˆì´ì…˜
"""

import rospy
import numpy as np
import json
import socket
import threading
import time
from geometry_msgs.msg import PoseStamped
import tf.transformations as tf_trans

class VRDataBridge:
    def __init__(self):
        rospy.init_node('vr_data_bridge')
        
        print("ğŸ¯ ë°ì´í„° ìˆ˜ì§‘ìš© VR Bridge ì‹œì‘")
        
        # VR ë°ì´í„°
        self.vr_data = {
            'position': np.array([0.0, 0.0, 0.0]),
            'orientation': np.array([0.0, 0.0, 0.0, 1.0]),
            'initial_position': None,
            'initial_orientation': None,
            'calibrated': False
        }
        
        # VR ì…ë ¥
        self.vr_inputs = {
            'button_upper': False,
            'button_lower': False
        }
        
        # ì†Œì¼“ ì„œë²„ ì„¤ì • (MuJoCo ìˆ˜ì§‘ê¸°ì™€ í†µì‹ )
        self.setup_socket_server()
        
        # ROS ì„¤ì •
        self.setup_ros_topics()
        
        # ì „ì†¡ ìŠ¤ë ˆë“œ
        self.send_thread = threading.Thread(target=self.send_loop, daemon=True)
        self.send_thread.start()
        
        print("âœ… VR ë°ì´í„° ë¸Œë¦¿ì§€ ì¤€ë¹„ ì™„ë£Œ!")
    
    def setup_socket_server(self):
        """ì†Œì¼“ ì„œë²„ ì„¤ì •"""
        try:
            self.server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            self.server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
            self.server_socket.bind(('0.0.0.0', 12346))  # ë‹¤ë¥¸ í¬íŠ¸ ì‚¬ìš©
            self.server_socket.listen(5)
            self.clients = []
            
            accept_thread = threading.Thread(target=self.accept_clients, daemon=True)
            accept_thread.start()
            
            print("âœ… ì†Œì¼“ ì„œë²„ ì‹œì‘: í¬íŠ¸ 12346")
        except Exception as e:
            print(f"âŒ ì†Œì¼“ ì„œë²„ ì˜¤ë¥˜: {e}")
    
    def accept_clients(self):
        """í´ë¼ì´ì–¸íŠ¸ ìˆ˜ë½"""
        while True:
            try:
                client, addr = self.server_socket.accept()
                self.clients.append(client)
                print(f"ğŸ”— MuJoCo ìˆ˜ì§‘ê¸° ì—°ê²°: {addr}")
            except:
                break
    
    def setup_ros_topics(self):
        """ROS í† í”½ ì„¤ì •"""
        rospy.Subscriber('/q2r_left_hand_pose', PoseStamped, self.hand_pose_callback)
        
        try:
            from quest2ros.msg import OVR2ROSInputs
            rospy.Subscriber('/q2r_left_hand_inputs', OVR2ROSInputs, self.input_callback)
            print("âœ… VR ì…ë ¥ í† í”½ êµ¬ë…ë¨")
        except ImportError:
            print("âš ï¸ OVR2ROSInputs ë©”ì‹œì§€ ì—†ìŒ")
        
        print("âœ… ROS í† í”½ ì„¤ì • ì™„ë£Œ")
    
    def hand_pose_callback(self, msg):
        """VR ì† Pose ì½œë°±"""
        self.vr_data['position'] = np.array([
            msg.pose.position.x,
            msg.pose.position.y,
            msg.pose.position.z
        ])
        
        self.vr_data['orientation'] = np.array([
            msg.pose.orientation.x,
            msg.pose.orientation.y,
            msg.pose.orientation.z,
            msg.pose.orientation.w
        ])
        
        # ì´ˆê¸° ìº˜ë¦¬ë¸Œë ˆì´ì…˜
        if not self.vr_data['calibrated']:
            self.vr_data['initial_position'] = self.vr_data['position'].copy()
            self.vr_data['initial_orientation'] = self.vr_data['orientation'].copy()
            self.vr_data['calibrated'] = True
            print("ğŸ– VR ì»¨íŠ¸ë¡¤ëŸ¬ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì™„ë£Œ")
    
    def input_callback(self, msg):
        """VR ì…ë ¥ ì½œë°±"""
        try:
            if hasattr(msg, 'button_upper'):
                self.vr_inputs['button_upper'] = msg.button_upper
            if hasattr(msg, 'button_lower'):
                self.vr_inputs['button_lower'] = msg.button_lower
            
            # A+B ë²„íŠ¼ìœ¼ë¡œ ì¬ìº˜ë¦¬ë¸Œë ˆì´ì…˜
            if (self.vr_inputs['button_upper'] and 
                self.vr_inputs['button_lower']):
                self.recalibrate()
                
        except Exception as e:
            rospy.logwarn(f"ì…ë ¥ ì²˜ë¦¬ ì˜¤ë¥˜: {e}")
    
    def recalibrate(self):
        """ì¬ìº˜ë¦¬ë¸Œë ˆì´ì…˜"""
        if self.vr_data['position'] is not None:
            self.vr_data['initial_position'] = self.vr_data['position'].copy()
            self.vr_data['initial_orientation'] = self.vr_data['orientation'].copy()
            print("ğŸ”„ VR ì»¨íŠ¸ë¡¤ëŸ¬ ì¬ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì™„ë£Œ!")
    
    def get_vr_deltas(self):
        """VR ë¸íƒ€ ê³„ì‚°"""
        if not self.vr_data['calibrated']:
            return None
        
        # Position delta
        pos_delta = self.vr_data['position'] - self.vr_data['initial_position']
        
        # Orientation delta (ì˜¤ì¼ëŸ¬ê°)
        current_euler = tf_trans.euler_from_quaternion(self.vr_data['orientation'])
        initial_euler = tf_trans.euler_from_quaternion(self.vr_data['initial_orientation'])
        ori_delta = np.array(current_euler) - np.array(initial_euler)
        
        return {
            'position_delta': pos_delta.tolist(),
            'orientation_delta': ori_delta.tolist(),
            'absolute_position': self.vr_data['position'].tolist(),
            'absolute_orientation': self.vr_data['orientation'].tolist()
        }
    
    def send_loop(self):
        """ë°ì´í„° ì „ì†¡ ë£¨í”„"""
        rate = rospy.Rate(60)  # 60Hz
        
        while not rospy.is_shutdown():
            if self.clients and self.vr_data['calibrated']:
                vr_deltas = self.get_vr_deltas()
                
                if vr_deltas:
                    data = {
                        'vr_deltas': vr_deltas,
                        'vr_status': {
                            'calibrated': self.vr_data['calibrated'],
                            'button_upper': self.vr_inputs['button_upper'],
                            'button_lower': self.vr_inputs['button_lower']
                        },
                        'timestamp': rospy.Time.now().to_sec()
                    }
                    
                    json_data = json.dumps(data) + '\n'
                    
                    # ì—°ê²° ëŠê¸´ í´ë¼ì´ì–¸íŠ¸ ì œê±°
                    failed_clients = []
                    for client in self.clients:
                        try:
                            client.sendall(json_data.encode())
                        except:
                            failed_clients.append(client)
                    
                    for client in failed_clients:
                        if client in self.clients:
                            self.clients.remove(client)
            
            rate.sleep()
    
    def run(self):
        """ë©”ì¸ ì‹¤í–‰"""
        print("\nğŸ¯ === VR ë°ì´í„° ë¸Œë¦¿ì§€ ì‹¤í–‰ ì¤‘ ===")
        print("ğŸ– VR ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ììœ ë¡­ê²Œ ì›€ì§ì´ì„¸ìš”")
        print("ğŸ”„ A+B ë²„íŠ¼ìœ¼ë¡œ ì¬ìº˜ë¦¬ë¸Œë ˆì´ì…˜")
        print("ğŸ“¡ MuJoCo ìˆ˜ì§‘ê¸°ì— ì‹¤ì‹œê°„ ë°ì´í„° ì „ì†¡")
        print("=" * 50)
        
        last_print_time = time.time()
        
        try:
            while not rospy.is_shutdown():
                time.sleep(0.2)  # 200ms ê°„ê²©ìœ¼ë¡œ ì²´í¬
                
                current_time = time.time()
                
                # ìƒíƒœ ì¶œë ¥ (1ì´ˆë§ˆë‹¤ - ë¹ ë¥¸ ì—…ë°ì´íŠ¸!)
                if current_time - last_print_time >= 1.0:
                    print(f"\rğŸ“Š VR: {'âœ…' if self.vr_data['calibrated'] else 'âŒ'} | ì—°ê²°: {len(self.clients)}ê°œ", end="")
                    
                    if self.vr_data['calibrated']:
                        deltas = self.get_vr_deltas()
                        if deltas:
                            pos = deltas['position_delta']
                            ori = deltas['orientation_delta']
                            print(f" | Pos: X={pos[0]:+.3f} Y={pos[1]:+.3f} Z={pos[2]:+.3f} | Ori: R={ori[0]:+.3f} P={ori[1]:+.3f} Y={ori[2]:+.3f}", end="")
                    
                    print()  # ì¤„ë°”ê¿ˆ
                    last_print_time = current_time
                    
        except KeyboardInterrupt:
            print("\nâš ï¸ ì‚¬ìš©ìì— ì˜í•´ ì¤‘ë‹¨ë¨")
        
        print("ğŸ VR ë°ì´í„° ë¸Œë¦¿ì§€ ì¢…ë£Œ")

if __name__ == "__main__":
    try:
        bridge = VRDataBridge()
        bridge.run()
    except Exception as e:
        print(f"âŒ ì˜¤ë¥˜: {e}")
        import traceback
        traceback.print_exc()
